# Testing

Testing the OCI artifacts generated by this repo is easy.

## Setup
First configure `.env` file at the root of this repository with the following values:
```

export CONTAINER_REGISTRY='quay.io/<username>'
export REDHAT_REGISTRY_USERNAME='<username>'
export REDHAT_REGISTRY_PASSWORD='<password>'
```

Then run `source .env` to export those values.

### Credentials
The script assumes that you're logged into quay.io .
For registry.redhat.io you'll need a username and password.
You can either:
- [Get a Red Hat Login](https://access.redhat.com/articles/RegistryAuthentication#getting-a-red-hat-login-2)
- [Create a Registry Service Account](https://access.redhat.com/articles/RegistryAuthentication#creating-registry-service-accounts-6)

Once you have those, update the `.env` file with those values.

### Image Registry
I recommend using quay.io. By default the image name the build process will use is is `tssc-backstage-plugins`.
You can also add a `IMAGE_NAME` to your `.env` file and the script will use that value instead.

## Run the script
From the root of the repository run
```
./scripts/build-and-push.sh --release=1.x --push
```

You can also test before pushing:
```
./scripts/build-and-push.sh --release=1.x --push --dry-run
```


**NOTE**: The `release-x.y` tag should match the version used in the root `package.json` file.

## Run the dynamic plugin config utility script
After your image is pushed you should run the following:
```
yarn tsx utils/update-dynamic-plugins.ts \
  --registry '<registry>' \
  --username '<username>' \
  --repository '<repository>'
```

This will update the dynamic-plugins file in `development/configuration/rhdh/dynamic-plugins.yaml` with:
- your container registry
- your username
- your repository

The updated sections in `dynamic-plugins.yaml` should look something like:
`oci://quay.io/<username>/tssc-backstage-plugins:release-1.8`

You can use this file in your RHDH configuration to test.

The easiest way to test locally is with [RHDH-Local](https://github.com/redhat-developer/rhdh-local).
